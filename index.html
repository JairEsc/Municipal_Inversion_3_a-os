<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obras SIPDUS: Municipal</title>
    <link rel="stylesheet" href="style_tablero_inversion.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.3.7/dist/leaflet-search.src.css" />
    <script src="https://unpkg.com/leaflet-search@2.3.7/dist/leaflet-search.src.js"></script>


</head>

<body>
    <div id="contenedor_global" style="display: flex;">
        <div id="primera_mitad"
            style="width: 50vw;height: 100vh;display: inline-block;background-color: rgba(112, 114, 114,0.9);">

            <div id="map_tablero_inversion_hidalgo" class="mapa_web_inversion" style="float: right;display: block;">
                <script src="Datos/geojson_hgo.js"></script>
                <script>
                    let myHistoricRubrosChart;

                    function updateWorksSummary() {
                        const worksData = generate_values_Reduce_Mun_num_obras_por_rubro_por_año(municipio_actual);
                        const worksSummaryElement = document.getElementById('worksSummary');
                        let htmlContent = '';

                        const years = Object.keys(worksData).sort((a, b) => b - a); // Ordenar años de mayor a menor

                        if (years.length === 0) {
                            htmlContent = '<p class="no-data">No hay obras registradas para este municipio.</p>';
                        } else {
                            years.forEach(year => {
                                const yearWorks = worksData[year];
                                const rubros = Object.keys(yearWorks);

                                if (rubros.length > 0) { // Solo mostrar el año si tiene rubros con obras
                                    htmlContent += `
                                            <div class="year-section">
                                                <div class="year-title">${year}</div>
                                                <div class="divider"></div>
                                        `;
                                    rubros.forEach(rubro => {
                                        const numWorks = yearWorks[rubro];
                                        htmlContent += `<div class="work-item">${numWorks === 1 ? '1 obra ' : (numWorks + ' obras ')} de ${rubro}</div>`;
                                    });
                                    htmlContent += `</div>`;
                                }
                            });
                            const historicRubroTotalsByYear = {}; // To store counts for each rubro, per year
                            years.forEach(year => {
                                const yearWorks = worksData[year];
                                for (const rubro in yearWorks) {
                                    if (yearWorks.hasOwnProperty(rubro)) {
                                        if (!historicRubroTotalsByYear[rubro]) {
                                            historicRubroTotalsByYear[rubro] = {};
                                        }
                                        historicRubroTotalsByYear[rubro][year] = yearWorks[rubro];
                                    }
                                }
                            });
                            const allUniqueRubros = Object.keys(historicRubroTotalsByYear).sort();
                            const colorPalette = [
    'rgb(98,17,50)',    // Dark Red/Maroon
    'rgb(212,193,156)', // Light Beige/Tan
    'rgb(179,142,93)',  // Muted Orange/Brown
    'rgb(157,36,73)',   // Deep Rose/Magenta
    'rgb(112,114,114)', // Medium Grey
    'rgb(29,29,27)'     // Near Black
];

const datasets = years.reverse().map((year, index) => { // Added 'index' to the map callback
    const dataForThisYear = allUniqueRubros.map(rubro => {
        // Get the count for this rubro in this specific year, default to 0 if not present
        return historicRubroTotalsByYear[rubro] && historicRubroTotalsByYear[rubro][year] ?
            historicRubroTotalsByYear[rubro][year] : 0;
    });

    // Use the modulo operator (%) to cycle through the colorPalette
    const backgroundColor = colorPalette[index % colorPalette.length];
    
    // For borderColor, you might want a slightly darker/lighter version of the backgroundColor
    // or just use a solid color like black or white for contrast.
    // For simplicity, let's keep it the same as background or a generic dark/light.
    const borderColor = backgroundColor; // Or 'rgba(0,0,0,0.8)' or 'rgba(255,255,255,0.8)'

    return {
        label: `Año ${year}`,
        data: dataForThisYear,
        backgroundColor: backgroundColor, // Assign a single color for the whole dataset (year)
        borderColor: borderColor,
        borderWidth: 1
    };
});

                            // --- Render the Chart ---
                            const ctx = document.getElementById('lineplot_año_por_tipo_estatal').getContext('2d');

                            // Destroy existing chart instance if it exists
                            if (myHistoricRubrosChart) {
                                myHistoricRubrosChart.destroy();
                            }

                            myHistoricRubrosChart = new Chart(ctx, {
                                type: 'bar', // Bar chart type
                                data: {
                                    labels: allUniqueRubros, // Rubros on the X-axis
                                    datasets: datasets
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false, // Allows you to control chart size with CSS
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: 'Obras por Rubro y Año (Histórico)',
                                            font: {
                                                size: 18
                                            }
                                        },
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false
                                        }
                                    },
                                    scales: {
                                        x: {
                                            stacked: true, // Crucial for stacking by year
                                            title: {
                                                display: true,
                                                text: 'Rubro'
                                            }
                                        },
                                        y: {
                                            stacked: true, // Crucial for stacking by year
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Número de Obras'
                                            },
                                            ticks: {
                                                        stepSize: 1

                                            }
                                        },
                                    }
                                }
                            });
                        } 
                        worksSummaryElement.innerHTML = htmlContent;
                    }



                </script>
                <script>


                    // Función para actualizar el contenido de la tabla basado en municipio_actual
                    function updateWorksTable(rubro_sel) {
                        const tableBody = document.querySelector('#tabla_obras_municipal tbody');
                        const noDataMessage = document.getElementById('noDataMessage');
                        const worksData = generate_values_Mun_Rubro(municipio_actual, rubro_sel);

                        tableBody.innerHTML = ''; // Limpiar filas existentes

                        if (worksData.length === 0) {
                            noDataMessage.style.display = 'block'; // Mostrar mensaje de no datos
                            document.getElementById('tabla_obras_municipal').style.display = 'none'; // Ocultar tabla
                        } else {
                            noDataMessage.style.display = 'none'; // Ocultar mensaje de no datos
                            document.getElementById('tabla_obras_municipal').style.display = 'table'; // Mostrar tabla

                            // Ordenar los datos por año de forma descendente
                            const sortedWorks = worksData.sort((a, b) => {
                                // 1. Comparar por Ejercicio (Año) de forma descendente
                                // Si los años son diferentes, el orden se define por el año.
                                if (b.Ejercicio !== a.Ejercicio) {
                                    return b.Ejercicio - a.Ejercicio;
                                }

                                // 2. Si los Ejercicios son iguales, entonces comparar por Inversión de forma descendente
                                // Asegúrate de que 'Inversión' es un número para la comparación
                                const inversionA = parseFloat(a.Inversión || 0);
                                const inversionB = parseFloat(b.Inversión || 0);
                                return inversionB - inversionA;
                            });////Arreglar el order. Primero año, luego inversión.

                            sortedWorks.forEach(work => {
                                const row = tableBody.insertRow();
                                row.insertCell().textContent = work.Ejercicio;
                                const formattedInvestment = new Intl.NumberFormat('es-MX', {
                                    style: 'currency',
                                    currency: 'MXN', // Or your desired currency code
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                }).format(work.Inversión);
                                row.insertCell().textContent = formattedInvestment;
                                row.insertCell().textContent = work['Habitantes beneficiados'] === 0 ? 'Sin dato' : work['Habitantes beneficiados'];
                                const obraCell = row.insertCell();
                                obraCell.textContent = work.Obra;
                                obraCell.classList.add('obra-column'); // Añadir clase para estilos específicos
                            });
                        }
                    }
                    function updateInvTable() {
                        const tableBody = document.querySelector('#tabla_inversion_municipal tbody');
                        const noDataMessage = document.getElementById('noDataMessage2');
                        // Assuming generate_resumen_inversion_por_año returns an object like { 2022: { obrasTotal: ..., inversionTotal: ... }, ... }
                        const worksData = generate_resumen_inversion_por_año(municipio_actual);
                        console.log(worksData); // This will show the object structure

                        tableBody.innerHTML = ''; // Clear existing rows

                        // Check if the worksData object is empty (no years with data)
                        const years = Object.keys(worksData).sort((a, b) => b - a); 

                        if (years.length === 0) {
                            noDataMessage.style.display = 'block'; // Show no data message
                            document.getElementById('tabla_inversion_municipal').style.display = 'none'; // Hide table
                        } else {
                            noDataMessage.style.display = 'none'; // Hide no data message
                            document.getElementById('tabla_inversion_municipal').style.display = 'table'; // Show table

                            let totalObrasHistorico = 0;
                            let totalInversionHistorico = 0;

                            years.forEach((year) => {
                                const yearSummary = worksData[year];
                                totalObrasHistorico += yearSummary.obrasTotal;
                                totalInversionHistorico += yearSummary.inversionTotal;

                                const row = tableBody.insertRow();
                                row.insertCell().textContent = year;
                                row.insertCell().textContent = yearSummary.obrasTotal;

                                const formattedInvestment = new Intl.NumberFormat('es-MX', {
                                    style: 'currency',
                                    currency: 'MXN',
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                }).format(yearSummary.inversionTotal);
                                row.insertCell().textContent = formattedInvestment;
                            });

                            // --- Añadir el renglón del total histórico ---
                            const totalRow = tableBody.insertRow();
                            totalRow.classList.add('total-row'); // Añadir clase para estilos específicos

                            totalRow.insertCell().textContent = 'Histórico Total'; // Etiqueta para el total
                            totalRow.insertCell().textContent = totalObrasHistorico; // Suma total de obras
                            const formattedTotalInvestment = new Intl.NumberFormat('es-MX', {
                                style: 'currency',
                                currency: 'MXN',
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            }).format(totalInversionHistorico);
                            totalRow.insertCell().textContent = formattedTotalInvestment; // Suma total de inversión
                            // --- Fin del renglón del total histórico ---
                        
                        }
                    }

                </script>
                <script src="app.js"></script>
            </div>

        </div>
        <div id="segunda_mitad" style="height: 100vh; width: 50vw;display: block;">
            <div id="contenedor_historico" class=""
                style="width: 48vw;height: 30vh;overflow-y: scroll;overflow-x: hidden;">

                <div id="contenedor_historico_titulo_select"
                    style="width: 50vw;height: 2vh;display: flex;justify-content: center;padding-bottom: 1vh; background-color: lightgray;">

                    <p class="Titulos_graphs" >Número de obras por ejercicio</p>

                </div>
                <div id="contenedor_historico_canvas" style="height: 28vh;">
                    <div class="container" id="worksSummary">
                        <p class="no-data">Selecciona un municipio en el mapa para ver el resumen de obras.</p>
                    </div>
                    <canvas class="canva_de_chartjs"  id="lineplot_año_por_tipo_estatal"  style="margin-left: 0.5vw; margin-right: 0.5vw; width: 49vw;height: 40vh;display: block;"></canvas>
                    <!-- <canvas class="canva_de_chartjs"  id="lineplot_año_por_tipo_municipal"  style="margin-left: 0.5vw; margin-right: 0.5vw; width: 49vw;height: 40vh;display: none;"></canvas> -->
                </div>

            </div>

            <div id="contenedor_barplot_horizontal"
                style="height: 40vh;width: 50vw;;background-color: rgb(255, 255, 255)">
                <div id="contenedor_barplot_horizontal_titulo_select"
                    style="width: 50vw;height: 2vh;display: flex;justify-content: center;background-color: rgb(255, 255, 255);">
                    <p class="Titulos_graphs">Rubro: </p>
                    <select style="position: relative;height: 2vh;margin-left: 0.5vw;display: block;"
                        id="tipo_dropdown">
                        <option value="Espacios Públicos">Sin seleccionar</option>

                    </select>
                </div>

                <div id="scroll_de_barplot_tipos" class=""
                    style="width: 48vw;height: 38vh;overflow-y: scroll;">
                    <table id="tabla_obras_municipal" class="works-table">
                        <thead>
                            <tr>
                                <th>Año</th>
                                <th>Inversión</th>
                                <th>Beneficiarios</th>
                                <th>Obra</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Las filas de la tabla se insertarán aquí dinámicamente -->
                        </tbody>
                    </table>
                    <p class="no-data" id="noDataMessage" style="display: none;">No hay obras registradas para este
                        municipio.</p>
                </div>



            </div>
            <div id="contenedor_meses_titulo_canvas" class="blabla"
                style="width: 48vw;height: 30vh;overflow-y: scroll;overflow-x: hidden;">
                <div id="meses_titulo" style="width: 50vw;height: 2vh;display: block;">
                    <p class="Titulos_graphs" style="text-align: center;">Inversión Histórica</p>
                </div>
                <table id="tabla_inversion_municipal" class="works-table">
                    <thead>
                        <tr>
                            <th>Año</th>
                            <th>Obras</th>
                            <th>Inversión</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las filas de la tabla se insertarán aquí dinámicamente -->
                    </tbody>
                </table>
                <p class="no-data" id="noDataMessage2" style="display: none;">No hay obras registradas para este
                    municipio.</p>
            </div>


        </div>
        <script src="script_tablero_inversion_municipal.js"></script>
        <script src="script_actualizar_charts.js"></script>


    </div>



</body>

</html>